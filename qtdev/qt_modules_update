#!/bin/bash

branch=$(basename $PWD)

for subproject in */
do
    [ ! -f "${subproject}.git" ] && continue
    subproject=$(basename $subproject)

    echo "Updating $subproject"
    cd $subproject
    git fetch
    git checkout $branch

    stashsha=$(git stash create /dev/null)
    if [ ! -z $stashsha ]
    then
      git stash store $stashsha -m "From $0"
      git reset --hard
    fi

    git rebase origin/$branch

    if [ ! -z $stashsha ]
    then
      git stash pop
    fi

    git submodule update

    echo "$subproject Updated"
    cd ..
done
